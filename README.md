
# Introduction

The Blue Pill is a famous product of STM electronics. It  uses the  STM32F103C8T6, which is a cortex M3  based microcontroller:

https://stm32-base.org/boards/STM32F103C8T6-Blue-Pill.html
 

One of the reasons for the success of the Blue Pill is the IDE used to program the microcontroller, the STM32 cube IDE:

https://www.st.com/en/development-tools/stm32cubeide.html

It generates C and C++ code and also allows easy debugging using either the SW protocol or JTAG using, for instance, the st-link V2:

https://www.st.com/en/development-tools/st-link-v2.html

Because of the success of the Blue pill, some companies started to sell hardware based on the  Blue Pill's idea.

Within this repository, you will find how to configure your environment using only free software e.g. GDB, GCC, and Vscode to avoid the illegal usage of the  STM Cube IDE ( Hardware Abstraction Layer ) in parallel generating a cleaner code since the STM cube generates loads of useless code.


Another concern is that the C++ code generated by the STM32 cube IDE  doesn't use C++ features.

Within this repository, you will also find an example code using C++ showing how to configure registers based on the datasheet information to get the hardware working.

# Contents

## Installation and adjusts
[Installing openocd and gdb and gcc cross platform](#Installing)

[Adjusts for not official blue pill hardware](#Adjusting-script-for-the-Chinese-version)

## Basic compilation and debug
[Compiling the code](#compiling-the-code) 

[Example of debug session](#Example-of-debug-session)

## Using Vscode to compile and debug
[Using vscode to compile](#Using-vscode-to-compile)

[Using vscode to debug](#Using-vscode-to-debug)


## Installing

## st-link

```
 apt install stlink-tools
 ```

## openocd

```
sudo apt install openocd
```

## gcc and gdb

```
apt install gcc-arm-none-eabi
```

For the `gdb` is very important to remember that nowadays a separated `gdb` is not needed. It's just needed to install the `gdb-multiarch`

```
apt install gdb-multiarch
```

## compiling the code

    git clone https://github.com/lord-feistel/stm32_baremetal
    cd stm32_baremetal
    make

If everything ok you will get this screen

![gcc](https://github.com/lord-feistel/baremetal/blob/master/images/output_make.png)

and the led will start to blink

## running openocd

```
sudo openocd -f /usr/share/openocd/scripts/interface/stlink-v2.cfg  -f /usr/share/openocd/scripts/target/stm32f1x.cfg 
```

## Adjusting script for the Chinese version

Since the SWD is not official version of the blue pill an error will be displayed related to the id

```
neo@matrix:~/repo/baremetal/timer$ sudo openocd -f /usr/share/openocd/scripts/interface/stlink-v2.cfg  -f /usr/share/openocd/scripts/target/stm32f1x.cfg
Open On-Chip Debugger 0.11.0-rc2
Licensed under GNU GPL v2
For bug reports, read
	http://openocd.org/doc/doxygen/bugs.html
WARNING: interface/stlink-v2.cfg is deprecated, please switch to interface/stlink.cfg
Info : auto-selecting first available session transport "hla_swd". To override use 'transport select <transport>'.
Info : The selected transport took over low-level target control. The results might differ compared to plain JTAG/SWD
Info : Listening on port 6666 for tcl connections
Info : Listening on port 4444 for telnet connections
Info : clock speed 1000 kHz
Info : STLINK V2J37S7 (API v2) VID:PID 0483:3748
Info : Target voltage: 3.168811
Warn : UNEXPECTED idcode: 0x2ba01477
Error: expected 1 of 1: 0x1ba01477
```

In order to fix that the following command must be used:
```
set CPUTAPID 0x2ba01477
```

This command comes at the begin of the ```stm32f1x.cfg``` file

Note: I get this code from an attempt to use the openocd on  the line :

    Warn : UNEXPECTED idcode: 0x2ba01477

## Example of debug session

**Terminal 1**
After run the command on the session  `running openocd` 

![openocd](https://github.com/lord-feistel/baremetal/blob/master/images/terminal_01_debug.png)

**Terminal 2**

after run :
```bash
gdb-multiarch ./app.elf
...
(gdb) target remote localhost:3333
```
![gdb](https://github.com/lord-feistel/baremetal/blob/master/images/terminal_02_debug.png)

## Using vscode to compile

In order to use the vscode to debug please download the files : `launch.json` and `tasks.jason` and do as in the following image ( they are on the .vscode of the repo project, thus just certifies they are there )

![gdb](https://github.com/lord-feistel/baremetal/blob/master/images/vscode_output.png)


## Using vscode to debug

1. Start the GDB

![gdb](https://github.com/lord-feistel/baremetal/blob/master/images/start_gdb.png)


2. Run the openocd 
```bash
sudo openocd -f /usr/share/openocd/scripts/interface/stlink-v2.cfg  -f /usr/share/openocd/scripts/target/stm32f1x.cfg 
```
3. The debug will start to work

![gdb running](https://github.com/lord-feistel/stm32_baremetal/blob/master/images/debug_running.png)

